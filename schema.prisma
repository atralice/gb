datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

// ---------- Core users ----------
enum UserRole {
  athlete
  trainer
  admin
}

model User {
  id    String   @id @default(uuid())
  email String   @unique
  name  String?
  role  UserRole @default(athlete)

  // Relationships trainer <-> athlete
  trainerRelationships TrainerAthlete[] @relation("TrainerToAthlete_trainer")
  athleteRelationships TrainerAthlete[] @relation("TrainerToAthlete_athlete")

  // Workout days
  trainerWorkoutDays WorkoutDay[] @relation("TrainerWorkoutDays")
  athleteWorkoutDays WorkoutDay[] @relation("AthleteWorkoutDays")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TrainerAthlete {
  trainerId String
  athleteId String

  trainer User @relation("TrainerToAthlete_trainer", fields: [trainerId], references: [id])
  athlete User @relation("TrainerToAthlete_athlete", fields: [athleteId], references: [id])

  createdAt DateTime @default(now())

  @@id([trainerId, athleteId])
}

// ---------- Programming structure ----------

enum Block {
  warmup
  a
  b
  c
  d // in case routines expand
}

model WorkoutDay {
  id          String    @id @default(uuid())
  weekNumber  Int       @default(1) // e.g. 10 (for grouping)
  dayIndex    Int // 1, 2, 3
  label       String? // "Día 1"
  datePlanned DateTime? // when you actually do it (optional)
  notes       String? // General notes for the workout day (e.g. "Entrada en calor: Movilidad A o B")

  trainerId String
  athleteId String

  trainer User @relation("TrainerWorkoutDays", fields: [trainerId], references: [id])
  athlete User @relation("AthleteWorkoutDays", fields: [athleteId], references: [id])

  exercises     WorkoutDayExercise[]
  blockComments WorkoutDayBlockComment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([athleteId, weekNumber, dayIndex])
}

// ---------- Block comments ----------

model WorkoutDayBlockComment {
  id           String @id @default(uuid())
  workoutDayId String
  block        Block // warmup / a / b / c / d
  comment      String // markdown supported for links

  workoutDay WorkoutDay @relation(fields: [workoutDayId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workoutDayId, block])
}

// ---------- Exercise library ----------

model Exercise {
  id           String  @id @default(uuid())
  name         String // e.g. "Sentadilla búlgara"
  instructions String? // markdown supported - short notes for form cues, can include links
  videoUrl     String? // YouTube link
  hasWeight    Boolean @default(false)
  tags         String[] @default([]) // e.g. ["fuerza", "pliometrico", "core"]

  workoutDayExercises WorkoutDayExercise[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ---------- Workout day exercises (with sets, feedback) ----------

model WorkoutDayExercise {
  id           String @id @default(uuid())
  exerciseId   String
  workoutDayId String

  block    Block // warmup / a / b / c / d
  order    Int // order inside the block (A1=1, A2=2, B1=3, etc.)
  comment  String? // markdown - e.g. "Reps por lado y peso total", "El peso equivale por mancuerna"
  variants String[] @default([]) // e.g. ["concentrica_explosiva", "core_activo"]

  exercise   Exercise   @relation(fields: [exerciseId], references: [id])
  workoutDay WorkoutDay @relation(fields: [workoutDayId], references: [id], onDelete: Cascade)
  sets       Set[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workoutDayId, block, order])
}

// ---------- Sets (prescribed by trainer) ----------

model Set {
  id                   String @id @default(uuid())
  workoutDayExerciseId String

  setIndex        Int // 1, 2, 3, 4, 5 (for ordering sets)
  reps            Int? // e.g. 8 (null if timed exercise)
  weightKg        Float? // e.g. 60 (null if bodyweight or no weight)
  durationSeconds Int? // for timed exercises like "40 seg" or holds
  repsPerSide     Boolean @default(false) // true if "Reps por lado" (reps per side)

  workoutDayExercise WorkoutDayExercise @relation(fields: [workoutDayExerciseId], references: [id], onDelete: Cascade)
  log                SetLog? // actual execution data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workoutDayExerciseId, setIndex])
}

// ---------- Set logs (actual execution by athlete) ----------

model SetLog {
  id    String @id @default(uuid())
  setId String @unique

  actualReps            Int? // what you actually did
  actualWeightKg        Float? // what you actually lifted
  actualDurationSeconds Int? // how long you actually held
  actualRpe             Int? // 1-10, how hard it felt
  completed             Boolean  @default(false) // did you do it at all?
  skipped               Boolean  @default(false) // explicitly skipped?
  notes                 String? // "felt easy", "grip failed", "subbed with X"

  completedAt DateTime @default(now())

  set Set @relation(fields: [setId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}