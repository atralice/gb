datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

// ---------- Core users ----------

enum UserRole {
  athlete
  trainer
  admin
}

model User {
  id    String   @id @default(uuid())
  email String   @unique
  name  String?
  role  UserRole @default(athlete)

  // Relationships trainer <-> athlete
  trainerRelationships TrainerAthlete[] @relation("TrainerToAthlete_trainer")
  athleteRelationships TrainerAthlete[] @relation("TrainerToAthlete_athlete")

  // Workout days
  trainerWorkoutDays WorkoutDay[] @relation("TrainerWorkoutDays")
  athleteWorkoutDays WorkoutDay[] @relation("AthleteWorkoutDays")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TrainerAthlete {
  trainerId String
  athleteId String

  trainer User @relation("TrainerToAthlete_trainer", fields: [trainerId], references: [id])
  athlete User @relation("TrainerToAthlete_athlete", fields: [athleteId], references: [id])

  createdAt DateTime @default(now())

  @@id([trainerId, athleteId])
}

// ---------- Exercise library ----------

model Exercise {
  id           String   @id @default(uuid())
  name         String   @unique // e.g. "Sentadilla búlgara"
  instructions String?  // markdown - form cues, can include links
  videoUrl     String?  // YouTube/video link
  tags         String[] @default([]) // e.g. ["fuerza", "piernas", "unilateral"]

  workoutBlockExercises WorkoutBlockExercise[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ---------- Workout structure ----------

model WorkoutDay {
  id            String   @id @default(uuid())
  weekNumber    Int      @default(1)
  weekStartDate DateTime
  dayIndex      Int
  label         String?
  datePlanned   DateTime?
  notes         String?

  trainerId String
  athleteId String

  trainer User @relation("TrainerWorkoutDays", fields: [trainerId], references: [id])
  athlete User @relation("AthleteWorkoutDays", fields: [athleteId], references: [id])

  blocks WorkoutBlock[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([athleteId, weekNumber, dayIndex])
  @@unique([athleteId, weekStartDate, dayIndex])
}

model WorkoutBlock {
  id           String @id @default(uuid())
  workoutDayId String

  order   Int     // 0, 1, 2, 3 (for sorting: warmup=0, a=1, b=2, c=3)
  label   String? // "A", "B", "Bloque pliométrico", "Entrada en calor"
  comment String? // markdown - e.g. "Descanso entre serie de 30 seg a 1 min..."

  workoutDay WorkoutDay             @relation(fields: [workoutDayId], references: [id], onDelete: Cascade)
  exercises  WorkoutBlockExercise[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workoutDayId, order])
}

model WorkoutBlockExercise {
  id             String @id @default(uuid())
  workoutBlockId String
  exerciseId     String

  order    Int      // 1, 2 (A1, A2 within block A)
  comment  String?  // markdown - e.g. "Reps por lado", "NO BALANCEAR"
  variants String[] @default([]) // e.g. ["tempo_3_1_0", "explosivo"]

  workoutBlock WorkoutBlock @relation(fields: [workoutBlockId], references: [id], onDelete: Cascade)
  exercise     Exercise     @relation(fields: [exerciseId], references: [id])
  sets         Set[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workoutBlockId, order])
}

// ---------- Sets (prescribed by trainer) ----------

model Set {
  id                     String @id @default(uuid())
  workoutBlockExerciseId String

  setIndex        Int      // 1, 2, 3... (for ordering)
  reps            Int?     // e.g. 8 (null if timed)
  weightKg        Float?   // e.g. 60 (null if bodyweight)
  durationSeconds Int?     // for timed exercises like "40 seg"
  repsPerSide     Boolean  @default(false) // true if "c/lado"

  workoutBlockExercise WorkoutBlockExercise @relation(fields: [workoutBlockExerciseId], references: [id], onDelete: Cascade)
  log                  SetLog?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([workoutBlockExerciseId, setIndex])
}

// ---------- Set logs (actual execution by athlete) ----------

model SetLog {
  id    String @id @default(uuid())
  setId String @unique

  actualReps            Int?
  actualWeightKg        Float?
  actualDurationSeconds Int?
  actualRpe             Int?     // 1-10
  completed             Boolean  @default(false)
  skipped               Boolean  @default(false)
  notes                 String?  // "grip failed", "subbed with X"

  completedAt DateTime @default(now())

  set Set @relation(fields: [setId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}